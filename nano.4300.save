from fastapi import FastAPI
import psycopg2
import json

app = FastAPI()

# Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
conn = psycopg2.connect(
    dbname="canicannabis",
    user="postgres",
    host="localhost"
)
cur = conn.cursor()

# =========================
# ðŸ”´ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ (Ø¯Ø§Ø¦Ù…Ù‹Ø§)
# =========================
@app.get("/zones/red")
def red_zones():
    cur.execute("SELECT ST_AsGeoJSON(geom), zone_color, restriction FROM red_zones;")
    rows = cur.fetchall()
    return {
        "type": "FeatureCollection",
        "features": [
            {
                "type": "Feature",
                "properties": {"color": row[1], "restriction": row[2]},
                "geometry": json.loads(row[0])
            }
            for row in rows
        ]
    }

# =========================
# ðŸ”µ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ (Ø¯Ø§Ø¦Ù…Ù‹Ø§)
# =========================
@app.get("/zones/blue")
def blue_zones():
    cur.execute("SELECT ST_AsGeoJSON(geom), zone_color, restriction FROM blue_zones;")
    rows = cur.fetchall()
    return {
        "type": "FeatureCollection",
        "features": [
            {
                "type": "Feature",
                "properties": {"color": row[1], "restriction": row[2]},
                "geometry": json.loads(row[0])
            }
            for row in rows
        ]
    }

# test endpoint
@app.get("/")
def home():
    return {"status": "Backend is running!"}
